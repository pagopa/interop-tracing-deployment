apiVersion: v1
kind: ConfigMap
metadata:
  name: common-flyway-redshift-tracing-schema
  namespace: dev-analytics
data:
  V1__Tracing_Schema.sql: |-
    CREATE SCHEMA IF NOT EXISTS tracing;

    GRANT USAGE ON SCHEMA tracing TO
      tracing_be_enriched_data_handler_${NAMESPACE};

    GRANT USAGE ON SCHEMA tracing TO GROUP
      readonly_group;

    GRANT CREATE, ALTER, DROP ON SCHEMA tracing TO 
      tracing_be_enriched_data_handler_${NAMESPACE};

    CREATE TABLE IF NOT EXISTS tracing.traces (
      id UUID PRIMARY KEY,
      tracing_id UUID,
      submitter_id UUID,
      date TIMESTAMP NOT NULL,
      purpose_id UUID,
      purpose_name VARCHAR(255),
      status INTEGER,
      requests_count INTEGER,
      eservice_id UUID,
      consumer_id UUID,
      consumer_origin VARCHAR(255),
      consumer_name VARCHAR(255),
      consumer_external_id UUID,
      producer_id UUID,
      producer_name VARCHAR(255),
      producer_origin VARCHAR(255),
      producer_external_id UUID,
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      token_id UUID
    );

    GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE tracing.traces TO
      tracing_be_enriched_data_handler_${NAMESPACE};
